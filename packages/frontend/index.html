<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº¬éƒ½3Dãƒãƒƒãƒ—</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.136/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.136/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    html, body, #cesiumContainer {
      width: 100%; height: 100%; margin: 0; padding: 0;
    }
    #locationBtn {
      position: absolute; top: 10px; left: 10px; z-index: 999;
      padding: 12px 20px; font-size: 16px; cursor: pointer;
      background: #4CAF50; color: white;
      border: none; border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="locationBtn">ğŸ“ ç¾åœ¨åœ°ã¸ç§»å‹•</button>

<script type="module">

// â†“ã“ã“ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥ã‚Œã‚‹

Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmMGY5MjhkYS02M2IxLTQzZGMtOGM4YS1hOTkzZmEyMjJiZDgiLCJpZCI6MzY5NDQxLCJpYXQiOjE3NjU2NDgzODh9.HJe1_XsvK1G59lVTjxI-ow-b9DM2bEhPDzuX7psIk9U";

const viewer = new Cesium.Viewer("cesiumContainer", {
  terrain: Cesium.Terrain.fromWorldTerrain(),
  timeline: false, animation: false
});

// æ—¥æœ¬ã®3Då»ºç‰©ã‚’è¿½åŠ 
const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(2602291);
viewer.scene.primitives.add(tileset);

// åˆæœŸä½ç½®ï¼šäº¬éƒ½å¸‚å½¹æ‰€
viewer.camera.setView({
  destination: Cesium.Cartesian3.fromDegrees(135.7681, 35.0116, 800),
  orientation: {
    heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0
  }
});

// ç¾åœ¨åœ°ãƒœã‚¿ãƒ³
document.getElementById("locationBtn").addEventListener("click", () => {
  navigator.geolocation.getCurrentPosition((pos) => {
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(
        pos.coords.longitude, pos.coords.latitude, 500
      ),
      duration: 2
    });
  });
});

// WebSocket æ¥ç¶šï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒãƒ¼ãƒˆ 8080 ã‚’æƒ³å®šï¼‰
const socket = io('ws://localhost:8080');

// Socket.IO æ¥ç¶šã‚ªãƒ¼ãƒ—ãƒ³æ™‚ã®å‡¦ç†
socket.on('connect', () => {
  console.log('Socket.IO æ¥ç¶šæˆåŠŸ');
});

// Socket.IO ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†ï¼ˆåº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ”ãƒ³ã¨ã—ã¦è¿½åŠ ï¼‰
socket.on('coordinateReceived', (latitude, longitude, user) => {
  addPinFromCoordinate(latitude, longitude, user);
});

// Socket.IO ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
socket.on('connect_error', (error) => {
  console.error('Socket.IO ã‚¨ãƒ©ãƒ¼:', error);
});

// Socket.IO æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã®å‡¦ç†
socket.on('disconnect', () => {
  console.log('Socket.IO æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚º');
});

// åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦é’è‰²ã®ãƒ”ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°ï¼ˆå˜ä¸€åº§æ¨™ç”¨ï¼‰
function addPinFromCoordinate(latitude, longitude, user) {
  const height = 100;  // é«˜ã•ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 100m

  // æ—¢å­˜ãƒ”ãƒ³ã‚’å‰Šé™¤ï¼ˆåŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ›´æ–°ï¼‰
  const existingEntity = viewer.entities.getById(`player-pin-${user}`);
  if (existingEntity) {
    viewer.entities.remove(existingEntity);
  }

  // æ–°ã—ã„ãƒ”ãƒ³ã‚’è¿½åŠ 
  viewer.entities.add({
    id: `player-pin-${user}`,
    position: Cesium.Cartesian3.fromDegrees(longitude, latitude, height),
    point: {
      pixelSize: 15,
      color: Cesium.Color.BLUE.withAlpha(0.8),  // é’è‰²ã€é€æ˜åº¦ã§æ·¡ã
      outlineColor: Cesium.Color.CYAN,  // ã‚·ã‚¢ãƒ³ã§å…‰ã‚‹åŠ¹æœ
      outlineWidth: 3
    },
    label: {
      text: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${user}`,
      font: "10pt sans-serif",
      fillColor: Cesium.Color.WHITE,
      outlineColor: Cesium.Color.BLACK,
      outlineWidth: 1,
      verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
      pixelOffset: new Cesium.Cartesian2(0, -40)
    }
  });
}


</script>

</body>

</html>
